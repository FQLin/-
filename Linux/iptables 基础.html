<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>iptables 基础</title>
</head>
<body>
<div id="wmd-preview" class="wmd-preview"><div class="md-section-divider"></div><div class="md-section-divider"></div><h1 data-anchor-id="ut9w" id="iptables-基础">iptables 基础</h1><p data-anchor-id="1mwl"><code>Linux</code></p><hr><div class="md-section-divider"></div><h3 data-anchor-id="i6is" id="1iptables-基本命令">1.iptables 基本命令</h3><p data-anchor-id="ubjx">iptables 可以简单理解为 Linux 系统<strong>内核级防火墙</strong> netfilter 的用户态客户端。</p><p data-anchor-id="xlfn">Linux 管理员通过调用 iptables 命令，配置 Linux 内核 netfilter 模块规则，对网络数据包的流动进行管理。</p><p data-anchor-id="iaa8">iptables 语法</p><p data-anchor-id="5do1">我们来看看 iptables 命令的语法帮助信息，并将其保存到文本文件 <br>
想要通过步骤检查，可以在终端输入：</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="2b88"><ol class="linenums"><li class="L0"><code class="language-c++"><span class="pln">    sudo iptables </span><span class="pun">-</span><span class="pln">h </span><span class="pun">&gt;</span><span class="pln"> </span><span class="pun">~/</span><span class="pln">iptables_help</span></code></li></ol></pre><p data-anchor-id="fhx1">查看 iptables 表的规则</p><p data-anchor-id="vlt3">iptables 有[表 (tables)] 的概念，每张表又包含不同[链(chains)]，大部分情况下我们仅需要使用 filter 和 nat 两张表的链就可以完成功能。 <br>
使用以下命令可以查看 filter 表中的规则。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="txdo"><ol class="linenums"><li class="L0"><code class="language-c++"><span class="pln">sudo iptables </span><span class="pun">-</span><span class="pln">L </span><span class="pun">-</span><span class="pln">n</span></code></li></ol></pre><blockquote data-anchor-id="ycz6" class="white-blockquote">
  <p>参数解析 -L 列出规则， -n 不显示域名，命令默认显示的是 filter 表，可以通过 -t 参数来指定其他表</p>
</blockquote><p data-anchor-id="yyjw">可以看到目前 filter 表中有 3 条链: INPUT, FORWARD, OUTPUT。 3 条链都没有任何规则存在，因此通过网卡的网络数据包不会受到任何影响。</p><blockquote data-anchor-id="bopd" class="white-blockquote">
  <p>iptables 包含 5 张表（tables）：</p>
  
  <ul>
  <li>raw 用于配置数据包，raw 中的数据包不会被系统跟踪。</li>
  <li>filter 是用于存放所有与防火墙相关操作的默认表。</li>
  <li>nat 用于网络地址转换（例如：端口转发）。</li>
  <li>mangle 用于对特定数据包的修改。</li>
  <li>security 用于强制访问控制网络规则。</li>
  </ul>
  
  <p>链可以看作是一系列规则集合，默认的链被用于不同的场景，用户也可以创建自定义的链。例如：</p>
  
  <ul>
  <li>filter 表的 INPUT 链用于进入网卡的数据包过滤</li>
  <li>filter 表的 OUTPUT 链用于过滤网卡对外发送的数据包过滤 一条链中的规则从上自下顺序执行。</li>
  </ul>
</blockquote><p data-anchor-id="r0zt">实验</p><p data-anchor-id="z9fd">请使用 iptables 命令查看 nat 表的规则，并输出到 /home/ubuntu/iptables_nat</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="ezgd"><ol class="linenums"><li class="L0"><code class="language-c++"><span class="pln">sudo iptables </span><span class="pun">-</span><span class="pln">L </span><span class="pun">-</span><span class="pln">n </span><span class="pun">-</span><span class="pln">t nat </span><span class="pun">&gt;</span><span class="pln"> </span><span class="str">/home/</span><span class="pln">ubuntu</span><span class="pun">/</span><span class="pln">iptables_nat</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="6vvr" id="2场景禁止访问目的地址">2.场景：禁止访问目的地址</h3><p data-anchor-id="zj75">添加一条规则到 Filter 表 <br>
在没有任何防火墙规则时，尝试 ping 百度的服务器，ping 是可以正常返回的。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="nup1"><ol class="linenums"><li class="L0"><code class="language-c++"><span class="pln">ping </span><span class="pun">-</span><span class="pln">c </span><span class="lit">4</span><span class="pln"> www</span><span class="pun">.</span><span class="pln">baidu</span><span class="pun">.</span><span class="pln">com</span></code></li><li class="L1"><code class="language-c++"><span class="pln">PING qcloud</span><span class="pun">.</span><span class="pln">com </span><span class="pun">(</span><span class="lit">119.29</span><span class="pun">.</span><span class="lit">47.192</span><span class="pun">)</span><span class="pln"> </span><span class="lit">56</span><span class="pun">(</span><span class="lit">84</span><span class="pun">)</span><span class="pln"> bytes of data</span><span class="pun">.</span></code></li><li class="L2"><code class="language-c++"><span class="lit">64</span><span class="pln"> bytes </span><span class="kwd">from</span><span class="pln"> </span><span class="lit">119.29</span><span class="pun">.</span><span class="lit">47.192</span><span class="pun">:</span><span class="pln"> icmp_seq</span><span class="pun">=</span><span class="lit">1</span><span class="pln"> ttl</span><span class="pun">=</span><span class="lit">58</span><span class="pln"> time</span><span class="pun">=</span><span class="lit">3.11</span><span class="pln"> ms</span></code></li><li class="L3"><code class="language-c++"><span class="lit">64</span><span class="pln"> bytes </span><span class="kwd">from</span><span class="pln"> </span><span class="lit">119.29</span><span class="pun">.</span><span class="lit">47.192</span><span class="pun">:</span><span class="pln"> icmp_seq</span><span class="pun">=</span><span class="lit">2</span><span class="pln"> ttl</span><span class="pun">=</span><span class="lit">58</span><span class="pln"> time</span><span class="pun">=</span><span class="lit">3.10</span><span class="pln"> ms</span></code></li><li class="L4"><code class="language-c++"><span class="lit">64</span><span class="pln"> bytes </span><span class="kwd">from</span><span class="pln"> </span><span class="lit">119.29</span><span class="pun">.</span><span class="lit">47.192</span><span class="pun">:</span><span class="pln"> icmp_seq</span><span class="pun">=</span><span class="lit">3</span><span class="pln"> ttl</span><span class="pun">=</span><span class="lit">58</span><span class="pln"> time</span><span class="pun">=</span><span class="lit">3.17</span><span class="pln"> ms</span></code></li></ol></pre><p data-anchor-id="4yif">假设我们作为 Linux 管理员，不希望有人从本机 ping 百度的服务器，那么就可以用到如下的 iptables 命令：</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="apw8"><ol class="linenums"><li class="L0"><code class="language-c++"><span class="pln">sudo iptables </span><span class="pun">-</span><span class="pln">I OUTPUT </span><span class="pun">-</span><span class="pln">p icmp </span><span class="pun">-</span><span class="pln">d www</span><span class="pun">.</span><span class="pln">baidu</span><span class="pun">.</span><span class="pln">com </span><span class="pun">-</span><span class="pln">j DROP</span></code></li></ol></pre><blockquote data-anchor-id="g2fl" class="white-blockquote">
  <p>参数解析 -I 添加规则到链的最前面， -p 匹配协议， -d 匹配目的地址， -j DROP 将匹配的数据包实施丢掉动作</p>
</blockquote><p data-anchor-id="ydch"><strong>重要:</strong></p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="vtlh"><ol class="linenums"><li class="L0"><code class="language-c++"><span class="pun">因为在</span><span class="pln"> iptables </span><span class="pun">一个链中的规则是从上到下依次执行的，因此一条规则在链中的位置十分重要。</span></code></li><li class="L1"><code class="language-c++"></code></li><li class="L2"><code class="language-c++"><span class="pun">例如一条拒绝全部连接的规则</span><span class="pln"> </span><span class="pun">-</span><span class="pln">j REJECT </span><span class="pun">一定要放在链的最后，而允许通行的规则要放在这条规则之前。</span></code></li><li class="L3"><code class="language-c++"></code></li><li class="L4"><code class="language-c++"><span class="pun">否则所有网络数据包进入链后直接匹配到这条规则，将导致所有连接被拒绝。</span></code></li></ol></pre><p data-anchor-id="69bn">现在我们可以用 <code>sudo iptables -L -n</code> 命令看到 filter 表的 OUTPUT 链中新增了两条记录，其中 destination 地址是 DNS 返回的百度服务器 IP 地址。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="cada"><ol class="linenums"><li class="L0"><code class="language-c++"><span class="typ">Chain</span><span class="pln"> OUTPUT </span><span class="pun">(</span><span class="pln">policy ACCEPT</span><span class="pun">)</span></code></li><li class="L1"><code class="language-c++"><span class="pln">target     prot opt source               destination</span></code></li><li class="L2"><code class="language-c++"><span class="pln">DROP       icmp </span><span class="pun">--</span><span class="pln">  </span><span class="lit">0.0</span><span class="pun">.</span><span class="lit">0.0</span><span class="pun">/</span><span class="lit">0</span><span class="pln">            </span><span class="lit">220.181</span><span class="pun">.</span><span class="lit">112.244</span></code></li><li class="L3"><code class="language-c++"><span class="pln">DROP       icmp </span><span class="pun">--</span><span class="pln">  </span><span class="lit">0.0</span><span class="pun">.</span><span class="lit">0.0</span><span class="pun">/</span><span class="lit">0</span><span class="pln">            </span><span class="lit">220.181</span><span class="pun">.</span><span class="lit">111.188</span></code></li></ol></pre><p data-anchor-id="ttnn">这时再 ping 百度服务器会发现无法 ping 通了，因为访问百度服务器 IP 地址的数据包已经被防火墙过滤丢掉了</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="mblr"><ol class="linenums"><li class="L0"><code class="language-c++"><span class="pln">ping </span><span class="pun">-</span><span class="pln">c </span><span class="lit">4</span><span class="pln"> www</span><span class="pun">.</span><span class="pln">baidu</span><span class="pun">.</span><span class="pln">com</span></code></li><li class="L1"><code class="language-c++"><span class="pln">PING www</span><span class="pun">.</span><span class="pln">a</span><span class="pun">.</span><span class="pln">shifen</span><span class="pun">.</span><span class="pln">com </span><span class="pun">(</span><span class="lit">220.181</span><span class="pun">.</span><span class="lit">111.188</span><span class="pun">)</span><span class="pln"> </span><span class="lit">56</span><span class="pun">(</span><span class="lit">84</span><span class="pun">)</span><span class="pln"> bytes of data</span><span class="pun">.</span></code></li><li class="L2"><code class="language-c++"><span class="pln">ping</span><span class="pun">:</span><span class="pln"> sendmsg</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Operation</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> permitted</span></code></li><li class="L3"><code class="language-c++"><span class="pln">ping</span><span class="pun">:</span><span class="pln"> sendmsg</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Operation</span><span class="pln"> </span><span class="kwd">not</span><span class="pln"> permitted</span></code></li></ol></pre><div class="md-section-divider"></div><h3 data-anchor-id="dh3g" id="3场景导出编辑导入规则">3.场景：导出、编辑、导入规则</h3><p data-anchor-id="phb6">在进行一系列复杂的防火墙配置时，大多数时候不建议直接调用 iptables 做规则修改。 因为任何一条错误的配置或者一个 typo （输入错误）都有可能导致严重的网络问题。</p><p data-anchor-id="7dle">一个最佳实践是导出现有规则到文本文件，对该文本文件进行编辑，进行检查无误后再将其导入。</p><p data-anchor-id="qzsp"><strong>导出规则</strong> <br>
通过如下命令导出所有规则到文本文件</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="w0x9"><ol class="linenums"><li class="L0"><code class="language-c++"><span class="pln">sudo iptables</span><span class="pun">-</span><span class="pln">save </span><span class="pun">&gt;</span><span class="pln"> </span><span class="str">/home/</span><span class="pln">ubuntu</span><span class="pun">/</span><span class="pln">iptables_rules</span></code></li></ol></pre><p data-anchor-id="y3j1">编辑规则</p><p data-anchor-id="tfeo">在新标签页打开 iptables_rules，在 <code>filter 表的 :OUTPUT ACCEPT</code> 链下面添加一条规则</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="m0e6"><ol class="linenums"><li class="L0"><code class="language-c++"><span class="pun">-</span><span class="pln">A OUTPUT </span><span class="pun">-</span><span class="pln">p icmp </span><span class="pun">-</span><span class="pln">d </span><span class="lit">114.114</span><span class="pun">.</span><span class="lit">114.114</span><span class="pln"> </span><span class="pun">-</span><span class="pln">j DROP</span></code></li></ol></pre><p data-anchor-id="zvcu">导入规则 <br>
使用命令将编辑过的规则重新导入 iptables</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="swr4"><ol class="linenums"><li class="L0"><code class="language-c++"><span class="pln">sudo iptables</span><span class="pun">-</span><span class="pln">restore </span><span class="pun">/</span><span class="pln">home</span><span class="pun">/</span><span class="pln">ubuntu</span><span class="pun">/</span><span class="pln">iptables_rules</span></code></li></ol></pre><p data-anchor-id="ctep">使用 <code>sudo iptables -L -n</code> 查看是否有禁止 <code>ping 114.114.114.114</code> 的新增规则</p><p data-anchor-id="hhrf">使用 <code>sudo ping 114.114.114.114</code> 查看新规则是否生效</p><p data-anchor-id="97es">清除全部规则 <br>
现在我们清除上一小节中增加的规则，还原到没有任何规则的初始状态。</p><p data-anchor-id="g45p">Note：当你因为错误的配置 iptables 导致自己无法远程访问的时候，从 console 执行这条命令可以快速修复状态。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="f4me"><ol class="linenums"><li class="L0"><code class="language-c++"><span class="pln">sudo iptables </span><span class="pun">-</span><span class="pln">F</span></code></li></ol></pre><p data-anchor-id="ar6u">查看 iptables 规则，发现前面定义的规则已经被清除。</p><p data-anchor-id="9h5y">尝试 ping 百度服务器和 114.114.114.114，都恢复到可以 ping 的状态。</p><p data-anchor-id="5xnk">iptables 还提供 -X 参数清除自定义链， -Z 参数重置计数器</p><blockquote data-anchor-id="wuje" class="white-blockquote">
  <p>除默认链之外由用户自建的链</p>
</blockquote><div class="md-section-divider"></div><h3 data-anchor-id="0cgm" id="4iptables进阶场景黑白名单">4.iptables进阶场景：黑/白名单</h3><p data-anchor-id="nton">某公司禁止特定的 PC 设备访问和工作无关的网站，而其他设备则不受限制。</p><p data-anchor-id="602m">分析：</p><p data-anchor-id="0wdy">1.首先明确是对外访问限制，所以应该编辑 <code>iptables OUTPUT</code> 链进行限制</p><p data-anchor-id="i69p">2.其次，由于目的地址可能是数百个网站，针对每一台PC配置数百条规则是不可接受的，因此我们选择使用自建一条链来实现。</p><p data-anchor-id="eu2y">3.公司只限制部分 PC 访问，因此对 PC 的匹配最好使用 IP 地址匹配，不匹配的设备则不受限制。</p><p data-anchor-id="pq4i"><strong>Note:</strong> 对于进入 <code>INPUT</code> 链的入站规则还可以采用 mac 匹配。</p><p data-anchor-id="wtgl">实验： <br>
假设本机作为一台网关使用，被限制的目标网站有 114.114.114.114 和 220.181.111.188，被限制访问的 PC 就是本机。</p><p data-anchor-id="9z3c">查看本机 IP 地址。</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="zxkm"><ol class="linenums"><li class="L0"><code class="language-c++"><span class="pln">sudo ip a show eth0</span></code></li></ol></pre><p data-anchor-id="uw8x">在 <code>inet</code> 之后的就是本机网口的 IP 地址，例如 1<code>0.135.166.86</code></p><p data-anchor-id="40m9">编辑 iptables 规则：</p><p data-anchor-id="x1ef">//清除已有规则</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="kg2m"><ol class="linenums"><li class="L0"><code class="language-c++"><span class="pln">sudo iptables </span><span class="pun">-</span><span class="pln">F</span></code></li></ol></pre><p data-anchor-id="nfe0">//清除自建链</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="mlvk"><ol class="linenums"><li class="L0"><code class="language-c++"><span class="pln">sudo iptables </span><span class="pun">-</span><span class="pln">X</span></code></li></ol></pre><p data-anchor-id="90g4">//新建一个叫做 BLACKLIST 的链</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="dw82"><ol class="linenums"><li class="L0"><code class="language-c++"><span class="pln">sudo iptables </span><span class="pun">-</span><span class="pln">N BLACKLIST</span></code></li></ol></pre><p data-anchor-id="bu6z">//当访问的源 IP 地址是本机的时候进入 BLACKLIST 链</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="f6ml"><ol class="linenums"><li class="L0"><code class="language-c++"><span class="pln">sudo iptables </span><span class="pun">-</span><span class="pln">A OUTPUT </span><span class="pun">-</span><span class="pln">s </span><span class="lit">10.135</span><span class="pun">.</span><span class="lit">166.86</span><span class="pln"> </span><span class="pun">-</span><span class="pln">j BLACKLIST</span></code></li></ol></pre><p data-anchor-id="defb">//向 BLACKLIST 链添加 2 条规则</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="u8pa"><ol class="linenums"><li class="L0"><code class="language-c++"><span class="pln">sudo iptables </span><span class="pun">-</span><span class="pln">A BLACKLIST </span><span class="pun">-</span><span class="pln">d </span><span class="lit">114.114</span><span class="pun">.</span><span class="lit">114.114</span><span class="pln"> </span><span class="pun">-</span><span class="pln">j DROP</span></code></li><li class="L1"><code class="language-c++"><span class="pln">sudo iptables </span><span class="pun">-</span><span class="pln">A BLACKLIST </span><span class="pun">-</span><span class="pln">d </span><span class="lit">220.181</span><span class="pun">.</span><span class="lit">111.188</span><span class="pln"> </span><span class="pun">-</span><span class="pln">j DROP</span></code></li></ol></pre><p data-anchor-id="jwve">如上配置后，会发现本机已经无法 ping BLACKLIST 中的目的地址了。</p><ul data-anchor-id="awgv">
<li>如果后续要增加新的禁止访问的目的地址，则只需向 BLACKLIST 链添加新规则。</li>
<li>如果需要限制另一台 PC 通过本网关转发访问外网，则只需添加一条 OUTPUT 链的源 IP 匹配规则并指向 -j BLACKLIST。</li>
</ul><div class="md-section-divider"></div><h3 data-anchor-id="wk2n" id="5进阶场景端口映射">5.进阶场景：端口映射</h3><p data-anchor-id="bkpn">分析： 通常来讲应该首先考虑程序本身能否配置监听多个端口，或者使用负载均衡器作为代理程序。 但在本次实验中我们将使用 iptables 监听 8080 端口并将网络数据包转发给本地80端口</p><p data-anchor-id="cpcw">实验： <br>
首先测试 <code>telnet 0 80</code> 和 <code>telnet 0 8080</code> 可以看到 80 和 8080 端口都是不通的。</p><p data-anchor-id="5wrf">接下来我们用 netcat 监听 80 端口：</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="wy2w"><ol class="linenums"><li class="L0"><code class="language-c++"><span class="pln">sudo nc </span><span class="pun">-</span><span class="pln">k </span><span class="pun">-</span><span class="pln">l </span><span class="lit">80</span><span class="pln"> </span><span class="pun">&amp;</span></code></li></ol></pre><p data-anchor-id="qsb7">这时候 <code>telnet 0 80</code> 发现 80 端口可以工作了。</p><p data-anchor-id="gs6l">退出telnet需要按 Ctrl + ] （右方括号） ，再按 q 回车。</p><p data-anchor-id="4zbr">下面我们用 iptables 做一个端口映射</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="c0ti"><ol class="linenums"><li class="L0"><code class="language-c++"><span class="pln">sudo iptables </span><span class="pun">-</span><span class="pln">t nat </span><span class="pun">-</span><span class="pln">A OUTPUT </span><span class="pun">-</span><span class="pln">p tcp </span><span class="pun">-</span><span class="pln">d </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pln"> </span><span class="pun">--</span><span class="pln">dport </span><span class="lit">8080</span><span class="pln"> </span><span class="pun">-</span><span class="pln">j DNAT </span><span class="pun">--</span><span class="pln">to </span><span class="lit">127.0</span><span class="pun">.</span><span class="lit">0.1</span><span class="pun">:</span><span class="lit">80</span></code></li></ol></pre><p data-anchor-id="pzfc">这里我们用到了 -t nat 参数，表示我们使用了 netfilter 的 nat 表。在 nat 表的 OUTPUT 链上做了一个 -j DNAT 转发，将访问内网 8080 端口的数据包转向了 80 端口。</p><p data-anchor-id="4ykf">这时候 telnet 0 8080 发现 8080 端口也可以工作了。</p><p data-anchor-id="aazv">如果是监听外网的 8080 端口转发到 80 端口，则需要执行以下命令：</p><div class="md-section-divider"></div><pre class="prettyprint linenums prettyprinted" data-anchor-id="7hn0"><ol class="linenums"><li class="L0"><code class="language-c++"><span class="pln">sudo iptables </span><span class="pun">-</span><span class="pln">t nat </span><span class="pun">-</span><span class="pln">A PREROUTING </span><span class="pun">-</span><span class="pln">p tcp </span><span class="pun">--</span><span class="pln">dport </span><span class="lit">8080</span><span class="pln"> </span><span class="pun">-</span><span class="pln">j REDIRECT </span><span class="pun">--</span><span class="pln">to</span><span class="pun">-</span><span class="pln">ports </span><span class="lit">80</span></code></li></ol></pre><p data-anchor-id="x1pi">通过使用 PREROUTING 链直接将访问 8080 端口的数据包转发到 80 端口</p></div>
</body>
</html>